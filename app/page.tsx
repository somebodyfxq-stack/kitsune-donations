'use client';
import { useState, useMemo } from 'react'; import Link from 'next/link'; import { AmountPresets } from '@/components/AmountPresets';
export default function HomePage(){
  const [nickname,setNickname]=useState(''); const [amount,setAmount]=useState<number>(50); const [message,setMessage]=useState(''); const [submitting,setSubmitting]=useState(false); const [testing,setTesting]=useState(false); const [error,setError]=useState(''); const [toast,setToast]=useState('');
  const isAmountValid=amount>=10&&amount<=29999;
  const isValid=useMemo(()=>{ if(!nickname.trim()||!message.trim()) return false; if(!Number.isFinite(amount)) return false; if(!isAmountValid) return false; return true; },[nickname,amount,message,isAmountValid]);
  const showToast=(t:string)=>{setToast(t); setTimeout(()=>setToast(''),3000)};
  const openInNewTabNoRef=(url:string)=>{const a=document.createElement('a'); a.href=url; a.target='_blank'; a.rel='noopener noreferrer'; a.referrerPolicy='no-referrer'; a.style.display='none'; document.body.appendChild(a); a.click(); a.remove();};
  const handleSubmit=async(e:React.FormEvent)=>{e.preventDefault(); if(!isValid||submitting) return; setSubmitting(true); setError(''); try{ const qs=new URLSearchParams({nickname:nickname.trim(), amount:String(Math.round(amount)), message:message.trim().slice(0,500)}); const r=await fetch(`/api/donations/create?${qs.toString()}`,{cache:'no-store'}); const d=await r.json(); if(!r.ok||!d?.url) throw new Error(d?.error||'Помилка'); openInNewTabNoRef(d.url); showToast('Відкрито банку в новій вкладці'); }catch{ setError('Сталася помилка. Спробуйте ще раз.'); } finally{ setSubmitting(false);} };
  const handleTest=async()=>{ if(testing) return; setTesting(true); try{ const b={nickname:nickname.trim()||'kitsune_fan', amount:Math.round(amount)||50, message:message.trim()||'Тест повідомлення'}; const r=await fetch('/api/test',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify(b)}); if(!r.ok) throw new Error(); showToast('Надіслано тест сповіщення в OBS'); }catch{ showToast('Не вдалося надіслати тест'); } finally{ setTesting(false);} };
  return(<main className="min-h-screen relative overflow-hidden"><div className="pointer-events-none absolute inset-0"><div className="absolute -top-40 -left-40 h-[36rem] w-[36rem] rounded-full bg-fuchsia-600/20 blur-3xl"/><div className="absolute -bottom-40 -right-40 h-[36rem] w-[36rem] rounded-full bg-violet-600/20 blur-3xl"/></div><div className="relative mx-auto max-w-2xl px-6 py-14"><header className="mb-8 text-center"><h1 className="text-4xl md:text-5xl font-extrabold title-gradient drop-shadow-sm">Підтримати Kitsune</h1><div className="mt-3 badge">Безпечно через Monobank</div></header><form onSubmit={handleSubmit} className="card p-6 md:p-8 grid gap-6" aria-label="Форма донату"><div><label className="block mb-2 text-sm text-neutral-300">Сума</label><div className="flex gap-3 items-center"><input type="number" inputMode="numeric" min={10} max={29999} step={1} value={amount} onChange={(e)=>setAmount(Number(e.target.value))} className="input-base text-lg" aria-describedby="amount-hint" aria-label="Сума донату" required/><span className="pill flex flex-col items-center justify-center min-w-[80px] text-sm"><span>₴</span><span className="text-neutral-300">UAH</span></span></div><p id="amount-hint" className="mt-2 text-xs text-neutral-400">Сума від 10 до 29999 ₴</p>{!isAmountValid&&<p className="mt-2 text-xs text-rose-400">Сума має бути від 10 до 29999 ₴</p>}<div className="mt-3"><AmountPresets value={amount} onChange={setAmount}/></div></div><div className="grid gap-2"><label className="text-sm text-neutral-300">Ім&apos;я</label><input type="text" value={nickname} onChange={(e)=>setNickname(e.target.value)} placeholder="ваш нікнейм" className="input-base" aria-label="Нікнейм" required/></div><div className="grid gap-2"><label className="text-sm text-neutral-300">Повідомлення</label><textarea value={message} onChange={(e)=>setMessage(e.target.value)} placeholder="ваше повідомлення (макс. 500 символів)" className="input-base min-h-[120px] resize-y" maxLength={500} aria-label="Повідомлення" required/><p className="text-xs text-neutral-500">Максимум символів – 500</p></div>{error&&<p className="text-rose-400 text-sm">{error}</p>}<div className="grid sm:grid-cols-2 gap-3"><button type="submit" className="btn-primary w-full text-lg" disabled={!isValid||submitting} aria-label="Надіслати донат">{submitting?'Готуємо посилання…':'Надіслати'}</button><button type="button" className="btn-ghost w-full text-lg" onClick={handleTest} aria-label="Надіслати тест до OBS" disabled={testing}>{testing?'Тест…':'Тест сповіщення'}</button></div><div className="text-xs text-neutral-400 text-center">Посилання на банку відкриється у новій вкладці без реферера. Післядонату ваш нік, сума і повідомлення з’являться в OBS.</div></form><Link href="/login" className="mt-6 flex justify-center"><button type="button" className="btn-primary inline-flex items-center gap-2"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" className="w-5 h-5"><path d="M4.265 0L0 4.265v15.47h6.352V24l4.265-4.265h5.412L24 11.824V0H4.265zm17.647 11.824-3.706 3.706h-5.647l-3.529 3.53v-3.53H3.176V2.118h18.736v9.706z"/><path d="M13.765 5.882h2.118v5.647h-2.118zm-4.235 0h2.118v5.647H9.53z"/></svg>Sign in with Twitch</button></Link>{toast&&(<div className="fixed left-1/2 -translate-x-1/2 bottom-6 z-50"><div className="rounded-full bg-white/10 ring-1 ring-white/20 px-4 py-2 text-sm shadow-lg">{toast}</div></div>)}</div></main>);
}
